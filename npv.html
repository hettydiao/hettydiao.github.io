<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NPV Visualizer (Test Version)</title>
  <!-- PyScript 2024.5.x -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.5.2/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.5.2/core.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    p.hint { color:#444; margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size: 14px; }
    input, button, textarea { width: 100%; padding: 8px; font-size: 14px; }
    textarea { height: 70px; }
    #kpi { font-weight: 700; margin-top: 8px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background: #fff; }
    .stack { display: grid; gap: 16px; }
    .muted { color:#777; font-size:12px; }
    .warn { color:#c00; }
    .ok { color:#106a10; }
  </style>
</head>
<body>
  <h1> Net Present Value (NPV) – Calculator with Table & Charts</h1>
  <p class="hint"> Please click after typing in necessary inputs <b>Compute & Plot</b> The length of the inflows must equal to the number of years.</p>

  <div class="stack">
    <!-- Inputs -->
    <div class="card">
      <div class="row">
        <div>
          <label>Discount rate (e.g., 0.05 = 5%)</label>
          <input id="rate" type="number" step="0.005" min="0" value="0.05">
        </div>
        <div>
          <label>Initial investment (positive)</label>
          <input id="initial" type="number" step="100" min="0" value="1000">
        </div>
        <div>
          <label>Number of years</label>
          <input id="years" type="number" step="1" min="1" value="5">
        </div>
      </div>
      <div style="margin-top:12px;">
        <label>Cash flows (comma separated, length must equal “Number of years”)</label>
        <textarea id="cflows">400, 400, 400, 400, 400</textarea>
      </div>
      <div style="margin-top:12px;">
        <button id="run">Compute & Plot</button>
        <div id="kpi" class="muted">NPV = $0.00</div>
      </div>
    </div>

    <!-- RESULTS TABLE -->
    <div id="table" class="card" style="overflow:auto;"></div>

    <!-- CHARTS -->
    <div id="plot1" class="card"></div>
    <div id="plot2" class="card"></div>
  </div>

  <script type="py">
from js import document, console

# ---------- Core Calculators ----------
def fmt_money(x: float) -> str:
    return f"${x:,.2f}"

def compute_npv(rate: float, initial: float, cash_flows: list[float]):
    years = list(range(1, len(cash_flows) + 1))
    discounted = [cf / ((1 + rate) ** t) for t, cf in zip(years, cash_flows)]
    npv = sum(discounted) - initial
    cum_dcf = []
    s = 0.0
    for d in discounted:
        s += d
        cum_dcf.append(s)
    return years, discounted, cum_dcf, npv

# ---------- Table Renderer ----------
def render_table(years, cash_flows, discounted, cum_dcf):
    html = "<h3>Results Table</h3><table style='border-collapse:collapse;width:100%'>"
    html += (
        "<tr style='background:#fafafa'>"
        "<th style='text-align:left;padding:6px;border:1px solid #eee'>Year</th>"
        "<th style='text-align:right;padding:6px;border:1px solid #eee'>Cash Flow</th>"
        "<th style='text-align:right;padding:6px;border:1px solid #eee'>Discounted Cash Flow</th>"
        "<th style='text-align:right;padding:6px;border:1px solid #eee'>Cumulative DCF</th>"
        "</tr>"
    )
    for y, cf, d, c in zip(years, cash_flows, discounted, cum_dcf):
        html += (
            f"<tr>"
            f"<td style='padding:6px;border:1px solid #eee'>{y}</td>"
            f"<td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(cf)}</td>"
            f"<td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(d)}</td>"
            f"<td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(c)}</td>"
            f"</tr>"
        )
    html += "</table>"
    document.querySelector("#table").innerHTML = html

# ---------- SVG Chart Renderer ----------
def render_svg_bar_line(x_vals, bars, line_vals, title, y_label, hline=None):
    """
    bars: list of bar values (e.g., cash flows); can be []
    line_vals: list of line values (e.g., discounted / cumulative)
    hline: optional float -> draw a horizontal dashed reference line at this y-value
    """
    all_vals = []
    if bars: all_vals += bars
    if line_vals: all_vals += line_vals
    if not all_vals:
        all_vals = [0.0]
    # Expand range a bit for breathing room
    y_max = max(0.0, max(all_vals)) * 1.2
    y_min = min(0.0, min(all_vals)) * 1.2
    if y_max == y_min:
        # avoid division by zero if flat
        y_max += 1.0

    W, H, pad = 900, 360, 60
    inner_w, inner_h = W - 2*pad, H - 2*pad

    def y_to_px(v: float) -> float:
        return H - pad - (v - y_min) * inner_h / (y_max - y_min)

    def x_to_px(i: int) -> float:
        if len(x_vals) == 1:
            return pad + inner_w / 2
        return pad + i * (inner_w / (len(x_vals) - 1))

    svg = [f"<svg width='{W}' height='{H}' viewBox='0 0 {W} {H}' xmlns='http://www.w3.org/2000/svg'>"]
    # Title & labels
    svg.append(f"<text x='{W/2}' y='24' text-anchor='middle' font-size='16' font-weight='600'>{title}</text>")
    svg.append(f"<text x='{pad}' y='{H-8}' font-size='12'>Year</text>")
    svg.append(f"<text x='14' y='{H/2}' transform='rotate(-90,14,{H/2})' font-size='12'>{y_label}</text>")

    # Axes
    svg.append(f"<line x1='{pad}' y1='{pad}' x2='{pad}' y2='{H-pad}' stroke='black' stroke-width='1'/>")
    svg.append(f"<line x1='{pad}' y1='{H-pad}' x2='{W-pad}' y2='{H-pad}' stroke='black' stroke-width='1'/>")

    # Zero line
    zero_y = y_to_px(0.0)
    svg.append(f"<line x1='{pad}' y1='{zero_y}' x2='{W-pad}' y2='{zero_y}' stroke='gray' stroke-width='0.8'/>")

    # Optional reference horizontal line (e.g., initial investment level)
    if hline is not None:
        hy = y_to_px(hline)
        svg.append(f"<line x1='{pad}' y1='{hy}' x2='{W-pad}' y2='{hy}' stroke='#555' stroke-width='1.5' stroke-dasharray='6,6'/>")
        svg.append(f"<text x='{W-pad-4}' y='{hy-6}' text-anchor='end' font-size='12' fill='#555'>Reference: {fmt_money(hline)}</text>")

    # Bars
    if bars:
        # reasonable bar width cap to avoid over-wide bars for few points
        bar_w = max(8, min(30, inner_w / max(20, len(x_vals) * 2)))
        for i, v in enumerate(bars):
            x = x_to_px(i) - bar_w / 2
            y_top = y_to_px(max(0, v))
            y_bot = y_to_px(min(0, v))
            height = abs(y_bot - y_top)
            svg.append(f"<rect x='{x}' y='{min(y_top, y_bot)}' width='{bar_w}' height='{height}' fill='#88aaff' opacity='0.75' />")

    # Line + markers
    if line_vals:
        points = " ".join(f"{x_to_px(i)},{y_to_px(v)}" for i, v in enumerate(line_vals))
        svg.append(f"<polyline points='{points}' fill='none' stroke='#aa3344' stroke-width='2'/>")
        for i, v in enumerate(line_vals):
            svg.append(f"<circle cx='{x_to_px(i)}' cy='{y_to_px(v)}' r='3' fill='#aa3344'/>")

    # X ticks
    for i, xv in enumerate(x_vals):
        x = x_to_px(i)
        svg.append(f"<line x1='{x}' y1='{H-pad}' x2='{x}' y2='{H-pad+6}' stroke='black'/>")
        svg.append(f"<text x='{x}' y='{H-pad+18}' text-anchor='middle' font-size='12'>{int(xv)}</text>")

    svg.append("</svg>")
    return "".join(svg)

def render_plots(years, cash_flows, discounted, cum_dcf, initial):
    # Chart 1: Cash flows (bars) vs Discounted cash flows (line)
    svg1 = render_svg_bar_line(
        x_vals=years,
        bars=cash_flows,
        line_vals=discounted,
        title="Cash Flows (bars) vs Discounted Cash Flows (line)",
        y_label="Amount ($)",
        hline=None
    )
    document.querySelector("#plot1").innerHTML = svg1

    # Chart 2: Cumulative discounted inflows, with dashed line at initial investment
    svg2 = render_svg_bar_line(
        x_vals=years,
        bars=[],
        line_vals=cum_dcf,
        title="Cumulative Discounted Inflows vs Initial Investment",
        y_label="Amount ($)",
        hline=initial
    )
    document.querySelector("#plot2").innerHTML = svg2

# ---------- Button Handler ----------
def on_run(evt=None):
    try:
        r = float(document.querySelector("#rate").value)
        initial = float(document.querySelector("#initial").value)
        n = int(document.querySelector("#years").value)
        cflows_str = document.querySelector("#cflows").value.strip()
        # tolerate spaces
        cf_list = [float(x) for x in cflows_str.replace(" ", "").split(",") if x != ""]
        if len(cf_list) != n:
            raise ValueError(f"Expected {n} cash flows, got {len(cf_list)}.")
    except Exception as e:
        console.log(e)
        document.querySelector("#kpi").innerHTML = f"<span class='warn'>Error: {e}</span>"
        return

    years, discounted, cum_dcf, npv = compute_npv(r, initial, cf_list)
    # KPI
    kpi = f"NPV = {fmt_money(npv)}"
    document.querySelector("#kpi").innerHTML = f"<span class='ok'>{kpi}</span>"

    # Render table + charts
    render_table(years, cf_list, discounted, cum_dcf)
    render_plots(years, cf_list, discounted, cum_dcf, initial)

# Wire up
btn = document.querySelector("#run")
if btn:
    btn.addEventListener("click", on_run)
# Optional: initial auto-run
on_run()
  </script>
</body>
</html>
