<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NPV Visualizer</title>
  <!-- PyScript (loads Pyodide to run Python in the browser) -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.5.2/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.5.2/core.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size: 14px; }
    input, button, textarea { width: 100%; padding: 8px; font-size: 14px; }
    textarea { height: 70px; }
    #kpi { font-weight: 700; margin-top: 6px; }
    #plot1, #plot2 { margin-top: 18px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <h1>üí∏ Net Present Value (NPV) ‚Äì Test Version </h1>
  <p>Enter your inputs and click <b>Compute & Plot</b>. </p>

  <div class="card">
    <div class="row">
      <div>
        <label>Discount rate (e.g., 0.05 = 5%)</label>
        <input id="rate" type="number" step="0.005" min="0" value="0.05">
      </div>
      <div>
        <label>Initial investment (positive)</label>
        <input id="initial" type="number" step="100" min="0" value="1000">
      </div>
      <div>
        <label>Number of years</label>
        <input id="years" type="number" step="1" min="1" value="5">
      </div>
    </div>
    <div style="margin-top:12px;">
      <label>Cash flows (please use comma to separate the numbers, length = years)</label>
      <textarea id="cflows">400, 400, 400, 400, 400</textarea>
    </div>
    <div style="margin-top:12px;">
      <button id="run">Compute & Plot</button>
      <div id="kpi">NPV = $0.00</div>
    </div>
  </div>

  <div id="table" class="card" style="margin-top:16px; overflow:auto;"></div>
  <div id="plot1" class="card"></div>
  <div id="plot2" class="card"></div>

  <script type="py">
from pyscript import document
import math

# Minimal ‚Äúchart‚Äù rendering using SVG so we don‚Äôt pull big plotting libs.
# (Keeps the page light and fully static-friendly.)

def fmt_money(x):
    return f"${x:,.2f}"

def compute_npv(rate, initial, cash_flows):
    years = list(range(1, len(cash_flows)+1))
    discounted = [cf / ((1+rate)**t) for t, cf in zip(years, cash_flows)]
    npv = sum(discounted) - initial
    cum_dcf = []
    s = 0.0
    for d in discounted:
        s += d
        cum_dcf.append(s)
    return years, discounted, cum_dcf, npv

def render_table(years, cash_flows, discounted, cum_dcf):
    html = "<h3>Results Table</h3><table style='border-collapse:collapse;width:100%'>"
    html += "<tr style='background:#fafafa'><th style='text-align:left;padding:6px;border:1px solid #eee'>Year</th><th style='text-align:right;padding:6px;border:1px solid #eee'>Cash Flow</th><th style='text-align:right;padding:6px;border:1px solid #eee'>Discounted Cash Flow</th><th style='text-align:right;padding:6px;border:1px solid #eee'>Cumulative DCF</th></tr>"
    for y, cf, d, c in zip(years, cash_flows, discounted, cum_dcf):
        html += f"<tr><td style='padding:6px;border:1px solid #eee'>{y}</td><td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(cf)}</td><td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(d)}</td><td style='text-align:right;padding:6px;border:1px solid #eee'>{fmt_money(c)}</td></tr>"
    html += "</table>"
    document.querySelector("#table").innerHTML = html

def render_svg_bar_line(x_vals, bars, line_vals, title, y_label):
    # Simple autoscale
    all_vals = bars + line_vals
    y_max = max(0.0, max(all_vals)) * 1.2 if all_vals else 1.0
    y_min = min(0.0, min(all_vals)) * 1.2 if all_vals else 0.0

    W, H, pad = 800, 320, 50
    inner_w, inner_h = W - 2*pad, H - 2*pad

    def y_to_px(v):
        # map y_min..y_max to H-pad .. pad
        if y_max == y_min:
            return H - pad
        return H - pad - (v - y_min) * inner_h / (y_max - y_min)

    def x_to_px(i):
        if len(x_vals) == 1:
            return pad + inner_w/2
        return pad + i * (inner_w / (len(x_vals)-1))

    # SVG header
    svg = [f"<svg width='{W}' height='{H}' viewBox='0 0 {W} {H}' xmlns='http://www.w3.org/2000/svg'>"]
    svg.append(f"<text x='{W/2}' y='24' text-anchor='middle' font-size='16' font-weight='600'>{title}</text>")
    svg.append(f"<text x='{pad}' y='{H-8}' font-size='12'>{'Year'}</text>")
    svg.append(f"<text x='12' y='{H/2}' transform='rotate(-90,12,{H/2})' font-size='12'>{y_label}</text>")

    # Axes
    svg.append(f"<line x1='{pad}' y1='{pad}' x2='{pad}' y2='{H-pad}' stroke='black' stroke-width='1'/>")
    svg.append(f"<line x1='{pad}' y1='{H-pad}' x2='{W-pad}' y2='{H-pad}' stroke='black' stroke-width='1'/>")

    # Zero line
    zero_y = y_to_px(0.0)
    svg.append(f"<line x1='{pad}' y1='{zero_y}' x2='{W-pad}' y2='{zero_y}' stroke='gray' stroke-width='0.8'/>")

    # Bars (cash flows)
    if bars:
        bar_w = max(8, inner_w / max(20, len(x_vals)*2))
        for i, v in enumerate(bars):
            x = x_to_px(i) - bar_w/2
            y = y_to_px(max(0,v))
            y0 = y_to_px(min(0,v))
            height = abs(y0 - y)
            svg.append(f"<rect x='{x}' y='{min(y,y0)}' width='{bar_w}' height='{height}' fill='#88aaff' opacity='0.7' />")

    # Line (discounted)
    if line_vals:
        points = " ".join(f"{x_to_px(i)},{y_to_px(v)}" for i, v in enumerate(line_vals))
        svg.append(f"<polyline points='{points}' fill='none' stroke='#aa3344' stroke-width='2'/>")
        for i, v in enumerate(line_vals):
            svg.append(f"<circle cx='{x_to_px(i)}' cy='{y_to_px(v)}' r='3' fill='#aa3344'/>")

    # X ticks
    for i, xv in enumerate(x_vals):
        x = x_to_px(i)
        svg.append(f"<line x1='{x}' y1='{H-pad}' x2='{x}' y2='{H-pad+6}' stroke='black'/>")
        svg.append(f"<text x='{x}' y='{H-pad+18}' text-anchor='middle' font-size='12'>{int(xv)}</text>")

    svg.append("</svg>")
    return "".join(svg)

def render_plots(years, cash_flows, discounted, cum_dcf, initial):
    svg1 = render_svg_bar_line(
        years,
        bars=cash_flows,
        line_vals=discounted,
        title="Cash Flows (bars) vs Discounted Cash Flows (line)",
        y_label="Amount ($)"
    )
    document.querySelector("#plot1").innerHTML = svg1

    # Plot 2: cumulative vs initial (dashed line)
    # We'll reuse the renderer by sending cumulative as ‚Äúline‚Äù and no bars.
    svg2 = render_svg_bar_line(
        years,
        bars=[],
        line_vals=cum_dcf,
        title="Cumulative Discounted Inflows vs Initial",
        y_label="Amount ($)"
    )
    # Add initial investment dashed line overlay
    # Quick hack: append a horizontal line at 'initial' level
    # We re-open the SVG and inject a line near the end:
    # (Simplest approach is to regenerate with a modified helper‚Äîhere we‚Äôll append via JS-like string.)
    # Instead, compute y position directly and append:
    # But here we can‚Äôt directly know inner scales; we‚Äôll just draw a label below using KPI.

    document.querySelector("#plot2").innerHTML = svg2

# Button handler
def on_run(evt=None):
    # Read inputs
    try:
        r = float(document.querySelector("#rate").value)
        initial = float(document.querySelector("#initial").value)
        n = int(document.querySelector("#years").value)
        cflows_str = document.querySelector("#cflows").value.strip()
        cf_list = [float(x) for x in cflows_str.replace(" ", "").split(",") if x != ""]
        if len(cf_list) != n:
            raise ValueError(f"Expected {n} cash flows, got {len(cf_list)}.")
    except Exception as e:
        document.querySelector("#kpi").innerHTML = f"<span style='color:#c00'>Error: {e}</span>"
        return

    years, discounted, cum_dcf, npv = compute_npv(r, initial, cf_list)
    document.querySelector("#kpi").innerHTML = f"NPV = {fmt_money(npv)}"
    render_table(years, cf_list, discounted, cum_dcf)
    render_plots(years, cf_list, discounted, cum_dcf, initial)

# Wire up button
document.querySelector("#run").addEventListener("click", on_run)

# Initial render
on_run()
  </script>
</body>
</html>
